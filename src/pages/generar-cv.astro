---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Generar CV">
  <Header />
  <main class="container mx-auto px-6 max-w-4xl py-12">
    <div class="animate-fade-in">
      <h1 class="text-4xl md:text-5xl font-serif font-bold mb-4 text-center">Genera tu CV profesional</h1>
      <p class="text-lg text-black/70 mb-8 text-center">
        Rellena el formulario con tus datos, elige una plantilla y obt√©n un PDF listo para enviar a empresas.
      </p>

      <form id="cv-form" class="space-y-6">
        <!-- Datos personales -->
        <section class="bg-white p-6 rounded-xl shadow-sm border border-black/10">
          <h2 class="text-2xl font-serif font-semibold mb-4">üìã Datos personales</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Nombre completo *</label>
              <input type="text" name="nombre" required class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Email *</label>
              <input type="email" name="email" required class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Tel√©fono</label>
              <input type="text" name="telefono" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Direcci√≥n</label>
              <input type="text" name="direccion" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1">Perfil profesional</label>
              <textarea name="perfil" rows="3" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50"></textarea>
            </div>
          </div>
        </section>

        <!-- Educaci√≥n -->
        <section class="bg-white p-6 rounded-xl shadow-sm border border-black/10">
          <h2 class="text-2xl font-serif font-semibold mb-4">üéì Educaci√≥n</h2>
          <p class="text-sm text-black/60 mb-4">Para m√∫ltiples estudios, separa los valores con <span class="font-mono bg-black/5 px-1">|</span></p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">T√≠tulos</label>
              <input type="text" name="educacion_titulos" placeholder="M√°ster en Ciberseguridad|Grado en Inform√°tica" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Instituciones</label>
              <input type="text" name="educacion_instituciones" placeholder="Universidad de M√°laga|Universidad de M√°laga" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Fechas</label>
              <input type="text" name="educacion_fechas" placeholder="2024-2026|2020-2024" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Descripciones <span class="text-black/40">(opcional)</span></label>
              <input type="text" name="educacion_descripciones" placeholder="Especializaci√≥n en forense|..." class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
          </div>
        </section>

        <!-- Experiencia -->
        <section class="bg-white p-6 rounded-xl shadow-sm border border-black/10">
          <h2 class="text-2xl font-serif font-semibold mb-4">üíº Experiencia</h2>
          <p class="text-sm text-black/60 mb-4">Separa los valores con <span class="font-mono bg-black/5 px-1">|</span></p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Puestos</label>
              <input type="text" name="experiencia_puestos" placeholder="Desarrollador|Asistente" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Empresas</label>
              <input type="text" name="experiencia_empresas" placeholder="Tech Solutions|InfoSys" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Fechas</label>
              <input type="text" name="experiencia_fechas" placeholder="2023-2024|2022-2023" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Descripciones</label>
              <input type="text" name="experiencia_descripciones" placeholder="Desarrollo backend|Soporte t√©cnico" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
            </div>
          </div>
        </section>

        <!-- Habilidades e Idiomas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <section class="bg-white p-6 rounded-xl shadow-sm border border-black/10">
            <h2 class="text-2xl font-serif font-semibold mb-4">‚öôÔ∏è Habilidades</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">T√©cnicas</label>
                <input type="text" name="habilidades_hard" placeholder="Python|JavaScript|Symfony" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Blandas</label>
                <input type="text" name="habilidades_soft" placeholder="Trabajo en equipo|Comunicaci√≥n" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
              </div>
            </div>
          </section>

          <section class="bg-white p-6 rounded-xl shadow-sm border border-black/10">
            <h2 class="text-2xl font-serif font-semibold mb-4">üåç Idiomas</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Idiomas</label>
                <input type="text" name="idiomas_nombres" placeholder="Espa√±ol|Ingl√©s" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Niveles</label>
                <input type="text" name="idiomas_niveles" placeholder="Nativo|B2" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
              </div>
            </div>
          </section>
        </div>

        <!-- Certificaciones y Proyectos (opcional) -->
        <details class="bg-white p-6 rounded-xl shadow-sm border border-black/10 open:bg-white">
          <summary class="text-2xl font-serif font-semibold cursor-pointer select-none">Certificaciones y proyectos <span class="text-black/40">(opcional)</span></summary>
          <div class="mt-4 space-y-6">
            <div>
              <h3 class="font-semibold text-lg mb-2">Certificaciones</h3>
              <div class="space-y-2">
                <input type="text" name="certificaciones_nombres" placeholder="Nombres (|)" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
                <input type="text" name="certificaciones_entidades" placeholder="Entidades (|)" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
                <input type="text" name="certificaciones_fechas" placeholder="Fechas (|)" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-lg mb-2">Proyectos</h3>
              <div class="space-y-2">
                <input type="text" name="proyectos_nombres" placeholder="Nombres (|)" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
                <input type="text" name="proyectos_descripciones" placeholder="Descripciones (|)" class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/30 bg-cream/50" />
              </div>
            </div>
          </div>
        </details>

        <!-- Plantilla -->
        <section class="bg-white p-6 rounded-xl shadow-sm border border-black/10">
          <h2 class="text-2xl font-serif font-semibold mb-4">üé® Plantilla</h2>
          <div class="flex flex-wrap gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="plantilla" value="modern" checked class="accent-black" />
              <span>Moderna</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="plantilla" value="classic" class="accent-black" />
              <span>Cl√°sica</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="plantilla" value="creative" class="accent-black" />
              <span>Creativa</span>
            </label>
          </div>
        </section>

        <!-- Bot√≥n de env√≠o -->
        <div class="text-center">
          <button type="submit" class="bg-black text-cream px-8 py-4 rounded-full font-medium hover:bg-black/80 transition text-lg shadow-md">
            Generar CV y descargar
          </button>
        </div>
      </form>

      <!-- Mensaje de estado -->
      <div id="status" class="mt-6 text-center"></div>
    </div>

    <div class="mt-8 text-center">
      <a href="/" class="text-black/60 hover:text-black transition-colors">‚Üê Volver al inicio</a>
    </div>
  </main>
</Layout>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }
</style>

<script>
  const form = document.getElementById('cv-form');
  const statusDiv = document.getElementById('status');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    statusDiv.innerHTML = '‚è≥ Generando CV, por favor espera...';

    try {
      const response = await fetch('https://curriculum-bot-fqsw.onrender.com/generar-cv', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        let errorMsg = 'Error al generar el CV';
        try {
          const errorData = await response.json();
          if (errorData.detail) errorMsg = errorData.detail;
        } catch {
          errorMsg = await response.text();
        }
        throw new Error(errorMsg);
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cv_${formData.get('plantilla') || 'modern'}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      statusDiv.innerHTML = '‚úÖ CV generado correctamente. La descarga deber√≠a comenzar.';
    } catch (error) {
      statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
    }
  });
</script>